graph TD

    %% 0. 시스템 시작 및 체크
    DH_START((대화 시작)) --> DH_STATE_CHECK{플레이어 상태 체크}

    %% 1. ST_IDLE: 초기 상태
    DH_STATE_CHECK -- ST_IDLE --> DH_IDLE_1["ID: DH_IDLE_1<br>유저: 안녕하세요!"]
    DH_IDLE_1 --> DH_IDLE_2["ID: DH_IDLE_2<br>할아버지: (힐끗 쳐다보면) 무슨 일인가?"]
    
    %% DH_IDLE_2에서 갈라지는 세 가지 선택지
    DH_IDLE_2 --> DH_IDLE_3["ID: DH_IDLE_3<br>유저: 혹시 이 근처에서 노란 고양이 못 보셨나요? 구조하러 왔거든요."]
    DH_IDLE_2 --> DH_IDLE_3_ALT1["ID: DH_IDLE_3_ALT1<br>유저: 아무것도 아니에요..."]
    DH_IDLE_2 --> DH_IDLE_3_ALT2["ID: DH_IDLE_3_ALT2<br>유저: 뭐하세요?"]

    %% 선택지별 결과
    DH_IDLE_3_ALT1 --> DH_IDLE_2_RES1["ID: DH_IDLE_2_RES1<br>할아버지: 별 싱거운 녀석 다 보겠네."]
    DH_IDLE_3_ALT2 --> DH_IDLE_2_RES2["ID: DH_IDLE_2_RES2<br>할아버지: (먼 산을 보며) 보면 모르나? 그냥 앉아서 쉬는 중이지. 늙은이 쉬는 거 구경할 거 아니면 제 갈 길 가게나."]

    %% 정석 루트 진행
    DH_IDLE_3 --> DH_IDLE_4["ID: DH_IDLE_4<br>할아버지: (귀찮은 듯) 노란 고양이? 이 동네에 고양이가 한둘이야? 그냥 노랗다는 말만 들어선 나도 몰라."]
    DH_IDLE_4 --> DH_IDLE_5["ID: DH_IDLE_5<br>유저: 몸에 핑크색 하트 모양 점이 있다고 하던데..."]
    DH_IDLE_5 --> DH_IDLE_6["ID: DH_IDLE_6<br>할아버지: 하트 점? 고놈들이 가만히 있어야 점이 있는지 보지. 정 찾고 싶으면 사진이라도 찍어와 봐. 그래야 누군지 알려줄 거 아닌가."]
    DH_IDLE_6 --> DH_IDLE_TRANS[[ID: DH_IDLE_TRANS<br>상태 변이: ST_PHOTO_NEED]]

    %% 2. ST_PHOTO_NEED: 사진 촬영 대기
    DH_STATE_CHECK -- ST_PHOTO_NEED --> DH_NEED_1["ID: DH_NEED_1<br>할아버지: 아직인가? 하트 점이 있는 사진을 가져와야 내가 누군지 알려주지."]
    DH_NEED_1 --> DH_NEED_2["ID: DH_NEED_2<br>유저: 네, 하트 점이 잘 보이게 찍어올게요!"]
    DH_NEED_2 --> DH_NEED_ACTION((ID: DH_NEED_ACTION<br>액션 요구: 사진을 보여주세요))

    %% 3. ST_PHOTO_WRONG: 사진이 노랑이가 아닐 때
    DH_STATE_CHECK -- ST_PHOTO_WRONG --> DH_WRONG_1["ID: DH_WRONG_1<br>유저: 할아버지, 사진 찍어왔어요! 이 고양이 맞죠?"]
    DH_WRONG_1 --> DH_WRONG_2["ID: DH_WRONG_2<br>할아버지: (사진을 쓱 보더니) 에잉, 이건 그냥 동네 흔한 고양이잖아."]
    DH_WRONG_2 --> DH_WRONG_3["ID: DH_WRONG_3<br>유저: 아... 비슷하게 생겨서 착각했나 봐요. 다시 제대로 찍어올게요!"]
    DH_WRONG_3 --> DH_WRONG_TRANS[[ID: DH_WRONG_TRANS<br>상태 변이: ST_PHOTO_NEED]]

    %% 4. ST_PHOTO_SUCCESS: 사진이 노랑이가 맞을 때 (사연 인지)
    DH_STATE_CHECK -- ST_PHOTO_SUCCESS --> DH_SUCCESS_1["ID: DH_SUCCESS_1<br>유저: 할아버지, 여기요! 겨우 찍었어요. 이 사진 속 고양이 보세요. 핑크색 하트 점이 선명하죠?"]
    DH_SUCCESS_1 --> DH_SUCCESS_2["ID: DH_SUCCESS_2<br>할아버지: 허어, 이 녀석이었구먼. 그래, 이 핑크색 하트 점... '노랑이'구나. 앞집 꼬마가 지어준 이름이지. 이 녀석을 구조하겠다고?"]
    DH_SUCCESS_2 --> DH_SUCCESS_3["ID: DH_SUCCESS_3<br>유저: 노랑이요? 이 고양이를 잘 아시나 봐요?"]
    DH_SUCCESS_3 --> DH_SUCCESS_4["ID: DH_SUCCESS_4<br>할아버지: 앞집 꼬마가 아주 아끼던 놈이었어. 매일 같이 붙어 다녔지."]
    DH_SUCCESS_4 --> DH_SUCCESS_5["ID: DH_SUCCESS_5<br>유저: 그런데 왜 안 데려갔어요? 고양이가 너무 가여워요."]
    DH_SUCCESS_5 --> DH_SUCCESS_6["ID: DH_SUCCESS_6<br>할아버지: 이삿날 아침에 어디 숨었는지, 꼬마애가 울면서 찾아도 끝내 못찾았나 보더라고."]
    DH_SUCCESS_6 --> DH_SUCCESS_7["ID: DH_SUCCESS_7<br>유저: 결국 꼬마가 떠날 때까지 못 보고 엇갈려 버린 거네요..."]
    DH_SUCCESS_7 --> DH_SUCCESS_8["ID: DH_SUCCESS_8<br>할아버지: 트럭이 떠나고 나서야 알고 쫓아갔지만, 결국 놓쳤지. 그날부터 매일 여기서 기다리기만 하다가 저렇게 기운이 다 빠진 게야."]
    DH_SUCCESS_8 --> DH_SUCCESS_TRANS[[ID: DH_SUCCESS_TRANS<br>상태 변이: ST_ITEM_NONE]]

    %% 5. ST_ITEM_NONE: 덫과 붕어빵 둘 다 없는 상태
    DH_STATE_CHECK -- ST_ITEM_NONE --> DH_NONE_1["ID: DH_NONE_1<br>유저: 노랑이 녀석... 구조하고 싶은데, 잡을 수가 없네요. 어쩌죠?"]
    DH_NONE_1 --> DH_NONE_2["ID: DH_NONE_2<br>할아버지: 녀석 참 고집 세지? 음... 옛날엔 붕어빵 냄새만 맡아도 자다가 달려오곤 했어. 그 꼬마랑 같이 나눠 먹던 그 향기를 아직도 못 잊는 게지. 불쌍한 녀석..."]
    DH_NONE_2 --> DH_NONE_3["ID: DH_NONE_3<br>유저: 아... 붕어빵 냄새요? 그럼 그 냄새로 노랑이를 유인해볼 수 있을까요?"]
    DH_NONE_3 --> DH_NONE_4["ID: DH_NONE_4<br>할아버지: 붕어빵은 저기 포장마차에서 팔고 있으니 필요하면 여기서 사 가면 될 걸세."]
    DH_NONE_4 --> DH_NONE_5["ID: DH_NONE_5<br>유저: 잘됐네요! 알려주셔서 고맙습니다!"]

    %% 6. ST_ITEM_ONLY_BAIT: 붕어빵만 있고 덫이 없는 상태
    DH_STATE_CHECK -- ST_ITEM_ONLY_BAIT --> DH_OBAIT_1["ID: DH_OBAIT_1<br>유저: 할아버지, 붕어빵은 샀는데 이제 그냥 가서 잡으면 될까요?"]
    DH_OBAIT_1 --> DH_OBAIT_2["ID: DH_OBAIT_2<br>할아버지: 붕어빵만 있다고 되는 게 아니야. 녀석 경계심이 보통이 아니라 맨손으론 어림없거든."]
    DH_OBAIT_2 --> DH_OBAIT_3["ID: DH_OBAIT_3<br>유저: 아... 그럼 어떡하죠? 그냥 지켜만 볼 수도 없고요."]
    DH_OBAIT_3 --> DH_OBAIT_4["ID: DH_OBAIT_4<br>할아버지: 마을 상점에 가보게. 거기서 고양이를 안전하게 구조할 수 있는 덫을 팔 거야."]
    DH_OBAIT_4 --> DH_OBAIT_5["ID: DH_OBAIT_5<br>유저: 그렇군요. 붕어빵과 덫이 필요하군요! 고맙습니다. 할아버지!"]
    DH_OBAIT_5 --> DH_OBAIT_6["ID: DH_OBAIT_6<br>할아버지: 허허, 그래 조심히 다녀오게나."]

    %% 7. ST_ITEM_ONLY_TRAP: 덫만 있고 붕어빵이 없는 상태
    DH_STATE_CHECK -- ST_ITEM_ONLY_TRAP --> DH_OTRAP_1["ID: DH_OTRAP_1<br>유저: 할아버지, 상점에서 덫은 구해왔어요! 이제 구조할 수 있겠죠?"]
    DH_OTRAP_1 --> DH_OTRAP_2["ID: DH_OTRAP_2<br>할아버지: 덫만으론 안 되지. 노랑이는 붕어빵을 좋아한다구! 냄새나는 미끼가 있어야 녀석이 올 거 아냐."]
    DH_OTRAP_2 --> DH_OTRAP_3["ID: DH_OTRAP_3<br>유저: 아, 맞다! 포장마차에서 붕어빵을 사야겠네요!"]

    %% 8. ST_ITEM_READY: 덫과 붕어빵 둘 다 있는 상태
    DH_STATE_CHECK -- ST_ITEM_READY --> DH_READY_1["ID: DH_READY_1<br>유저: 할아버지, 붕어빵이랑 덫 둘 다 챙겼어요! 이제 정말 가볼게요!"]
    DH_READY_1 --> DH_READY_2["ID: DH_READY_2<br>할아버지: 다 있는데 안 잡고 여기서 뭐 하고 있어? 붕어빵 식기 전에 어서 가봐!"]
    DH_READY_2 --> DH_READY_3["ID: DH_READY_3<br>유저: 네! 꼭 구조해서 올게요!"]

    %% 9. ST_CATCH_SUCCESS: 구조 성공 후
    DH_STATE_CHECK -- ST_CATCH_SUCCESS --> DH_FINAL_1["ID: DH_FINAL_1<br>할아버지: 오! 정말 노랑이를 구조했구먼! 고생 많았네."]
    DH_FINAL_1 --> DH_FINAL_2["ID: DH_FINAL_2<br>유저: 할아버지 덕분이에요. 이제 안전한 곳으로 데려갈게요."]
    DH_FINAL_2 --> DH_FINAL_3["ID: DH_FINAL_3<br>할아버지: 그래, 그 꼬마도 이 소식을 들으면 정말 기뻐할 게야. 자네가 참 큰일을 했어."]

    %% 스타일링
    style DH_STATE_CHECK fill:#fff2cc,stroke:#d6b656
    style DH_IDLE_TRANS,DH_WRONG_TRANS,DH_SUCCESS_TRANS fill:#dfd,stroke:#333
    style DH_NEED_ACTION fill:#f9f,stroke:#333